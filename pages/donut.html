<link rel='stylesheet' href='css/index.css' />

<canvas></canvas>

<script type='module'>
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@v0.119.0/build/three.module.js'
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@v0.119.0/examples/jsm/loaders/GLTFLoader.js'
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@v0.119.0/examples/jsm/controls/OrbitControls.js'
import { createCore } from './js/core.js'
import { COLORS, SHADOW_MAP } from './js/constants.js'

const createControls = (renderer, camera) => {
  return new OrbitControls(camera, renderer.domElement)
}

const loadDonut = async () => {
  const loader = new GLTFLoader()
  const model = await loader.loadAsync('assets/gltf/donut1.glb')

  {
    const donut = model.scene.getObjectByName('Donut')
    donut.traverse((node) => {
      node.castShadow = true
      node.receiveShadow = true
    })
  }

  {
    const plane = model.scene.getObjectByName('Plane')
    plane.receiveShadow = true
  }

  console.log(model.scene)

  return model.scene
}

const main = async () => {
  const canvas = document.querySelector('canvas')
  const core = createCore({ canvas })
  const { renderer, camera, scene, setAnimationLoop } = core
  
  camera.position.set(0.5, 0.4, 0.5)

  const controls = createControls(renderer, camera)
  controls.enableDamping = true
  controls.dampingFactor = 0.05
  controls.autoRotate = true

  {
    const intensity = 1.5
    const light = new THREE.SpotLight(COLORS.warmLight, intensity)
    light.castShadow = true
    light.angle = 60

    light.shadow.mapSize.width = SHADOW_MAP.width
    light.shadow.mapSize.height = SHADOW_MAP.height
    light.shadow.radius = 16

    light.position.set(-0.25, 0.5, 1)
    scene.add(light)
  }

  const donut = await loadDonut()
  scene.add(donut)

  setAnimationLoop(() => {
    controls.update()
  })
}

main()
</script>
