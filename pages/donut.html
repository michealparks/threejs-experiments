<title>ThreeJS Experiments: Donut | Micheal Parks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href='css/index.css' />

<a id='back' class='button' href='/threejs-experiments'>Back</a>

<script type='module'>
  if (window !== window.top) window.back.style.display = 'none'
</script>

<canvas></canvas>

<script type='module'>
import { THREE, createCore, createOrbitControls } from './js/core.js'
import { initXR } from './js/xr.js'
import { loadModels } from './js/loaders.js'
import { postprocessing } from './js/postprocessing.js'
import { COLORS, SHADOW_MAP } from './js/constants.js'

const main = async () => {
  const canvas = document.querySelector('canvas')
  const core = createCore({ canvas, ambientLight: 0.8 })
  const { renderer, camera, scene, setAnimationLoop } = core
  
  const composer = postprocessing.createComposer(renderer, scene, camera)
  const bloomPass = postprocessing.setBloomPass({
    composer,
    threshold: 0,
    strength: 0.3,
    radius: 0.5
  })
  postprocessing.setFxaaPass(composer)


  camera.position.set(1.0, 0.9, 1.0)

  const controls = createOrbitControls({ renderer, camera })

  const [donut, mug] = await loadModels([
    { src: 'assets/gltf/donut2.glb', shadows: true },
    { src: 'assets/gltf/mug_high.glb', shadows: true }
  ])

  {
    const plane = donut.getObjectByName('Plane')
    plane.castShadow = false
  }
  scene.add(donut)

  mug.position.set(-0.2, 0.0, -0.25)
  mug.rotation.set(0.0, -Math.PI / 4, 0.0)
  mug.updateMatrix()
  scene.add(mug)

  {
    const intensity = 5.0
    const light = new THREE.SpotLight(COLORS.warmLight, intensity)
    light.castShadow = true
    light.angle = 50
    light.penumbra = 1

    light.shadow.radius = 8
    light.shadow.bias = -0.0001

    light.position.set(1.2, 1, 1.2)
    light.target = donut.getObjectByName('Legs')
    scene.add(light)
  }

  const frame = () => {
    controls.update()
  }

  initXR({ renderer })
  setAnimationLoop({ frame, composer })
}

main()
</script>
