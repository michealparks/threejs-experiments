<title>ThreeJS Experiments: Donut | Micheal Parks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href='css/index.css' />

<a id='back' class='button' href='/threejs-experiments'>Back</a>

<script type='module'>
  if (window !== window.top) window.back.style.display = 'none'
</script>

<canvas></canvas>

<script type='module'>
import {
  THREE,
  renderer,
  camera,
  scene,
  ambientLight,
  setAnimationLoop,
  initXR,
  orbitControls
} from './js/core.js'

import { loadModels } from './js/loaders.js'
import { randNum } from './js/util.js'
import { COLORS, SHADOW_MAP } from './js/constants.js'
import { RGBELoader } from 'https://cdn.jsdelivr.net/npm/three@0.120.0/examples/jsm/loaders/RGBELoader.js'

const loadRGBE = (url) => {
  return new Promise((resolve) => {
    return new RGBELoader()
      .setDataType(THREE.UnsignedByteType)
      .load(url, resolve)
  })
}

ambientLight.intensity = 0.5

camera.near = 0.1
camera.far = 1000.0

const main = async () => {
  const texture = await loadRGBE('https://threejs.org/examples/textures/equirectangular/royal_esplanade_1k.hdr')
  const pmremGenerator = new THREE.PMREMGenerator(renderer)
	pmremGenerator.compileEquirectangularShader()
	const envMap = pmremGenerator.fromEquirectangular(texture).texture

  scene.background = envMap
  scene.environment = envMap

  texture.dispose()
  pmremGenerator.dispose()

  const controls = orbitControls()

  const [mug] = await loadModels([
    { src: 'assets/gltf/mug.glb' }
  ])

  const n = 300
  const mesh = mug.getObjectByName('Mug')
  const instancedMesh = new THREE.InstancedMesh(mesh.geometry, mesh.material, n)
  const matrix = new THREE.Matrix4()

  let i = 0
  while (i < n) {
    matrix.setPosition(randNum(4), randNum(4), randNum(4))
    instancedMesh.setMatrixAt(i, matrix)
    i += 1
  }

  scene.add(instancedMesh)

  const frame = () => {
    controls.update()
  }

  initXR()
  setAnimationLoop({ frame })
}

main()
</script>