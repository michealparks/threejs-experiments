<title>ThreeJS Experiments: Donut | Micheal Parks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href='css/index.css' />

<a id='back' class='button' href='/threejs-experiments'>Back</a>

<script type='module'>
  if (window !== window.top) window.back.style.display = 'none'
</script>

<canvas></canvas>

<script type='module'>
import { THREE, renderer, camera, scene, ambientLight, postprocessing, setAnimationLoop, createOrbitControls } from './js/core.js'
import { initXR } from './js/xr.js'
import { loadModels } from './js/loaders.js'
import { randNumInRange, randomPointInCircle } from './js/util.js'
import { createSkySphere } from './js/objects.js'
import { COLORS, SHADOW_MAP } from './js/constants.js'
import { fire } from './js/fire.js'

camera.near = 0.1
camera.far = 200.0
camera.position.set(20.0, 4.0, 18.0)

postprocessing.setBloomPass({
  threshold: 0,
  strength: 0.3,
  radius: 0.3
})

postprocessing.setFxaaPass()

const controls = createOrbitControls({ renderer, camera })
controls.autoRotate = false


const main = async () => {
  const handleProgress = (...args) => {
    console.log(args)
  }

  const [gltf] = await loadModels([
    {
      src: 'assets/gltf/FloatingRockScene.glb',
      shadows: true
    }
  ], handleProgress)

  fire.init(
    gltf.getObjectByName('Fire'),
    [
      gltf.getObjectByName('Ember1'),
      gltf.getObjectByName('Ember2'),
      gltf.getObjectByName('Ember3')
    ]
  )

  scene.add(gltf)

  {
    const intensity = 5.0
    const light = new THREE.PointLight(COLORS.warmLight, intensity)
    light.castShadow = true
    light.position.copy(gltf.getObjectByName('Fire').position)
    light.position.y = 1.4
    light.shadow.mapSize.width = SHADOW_MAP.width
    light.shadow.mapSize.height = SHADOW_MAP.height
    light.shadow.radius = 8
    light.shadow.bias = -0.0001
    scene.add(light)
  }

  {
    const intensity = 0.3
    const light = new THREE.HemisphereLight(COLORS.white, intensity)
    light.color.setHSL(0.6, 1, 0.6)
    light.groundColor.setHSL(0.095, 1, 0.75)
    light.position.set(0, 50, 0)
    scene.add(light)
  }

  {
    const intensity = 1.0
    const light = new THREE.DirectionalLight(COLORS.white, intensity)
    light.color.setHSL(0.1, 1, 0.95)
    light.position.set(-1, 1.75, 1)
    light.position.multiplyScalar(30)
    scene.add(light)
  }

  {
    const intensity = 30.0
    const light = new THREE.SpotLight(COLORS.warmLight, intensity)
    light.angle = 70
    light.penumbra = 1

    light.position.set(...Array(3).fill(30))
    // scene.add(light)
  }

  const sky = createSkySphere({ segments: 64 })
  scene.add(sky)

  const color = new THREE.Color()
  sky.material.color.getHSL(color)
  let l = color.l

  let lastTime = performance.now()
  let dt = 0.0
  let idl = 0.0001
  let dl = 0.0001
  const frame = (time) => {
    dt = time - lastTime
    lastTime = time

    l -= dl
    if (l < 0.0 || l > 1.0) {
      idl = -idl
      dl = idl
      if (l <= 0.0) l = 0.0
      if (l >= 1.0) l = 1.0
    }

    ambientLight.intensity = l
    sky.material.color.setHSL(color.h, color.s, l)
    fire.update(dt)
    controls.update()
  }

  initXR({ renderer })
  setAnimationLoop({ frame, postprocessing: true })
}

main()
</script>
