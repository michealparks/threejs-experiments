<title>ThreeJS Experiments: Room | Micheal Parks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href='css/index.css' />

<a id='back' class='button' href='/threejs-experiments'>Back</a>

<script type='module'>
  if (window !== window.top) window.back.style.display = 'none'
</script>

<style>
  button {
    position: fixed;
    bottom: 15px;
    left: 15px;
  }
</style>

<button id='postprocessing'>postprocessing</button>

<canvas></canvas>

<script type='module'>
import { THREE, createCore, createOrbitControls, loadModel } from './js/core.js'
import { postprocessing } from './js/postprocessing.js'
import { COLORS, SHADOW_MAP } from './js/constants.js'

const main = async () => {
  const canvas = document.querySelector('canvas')
  const core = createCore({
    canvas,
    ambientLight: 0.5,
    camera: { near: 0.1, far: 100.0 }
  })
  const { renderer, camera, scene } = core

  const composer = postprocessing.createComposer(renderer, scene, camera)
  postprocessing.setBloomPass(composer)
  postprocessing.setFxaaPass(composer)
  
  camera.position.set(15, 15, 15)

  const controls = createOrbitControls({ renderer, camera })
  controls.autoRotate = false
  controls.enableZoom = false
  controls.enablePan = false

  {
    const intensity = 3.0
    const light = new THREE.SpotLight(COLORS.warmLight, intensity)
    light.angle = 0.8
    light.penumbra = 1.0

    light.castShadow = true
    light.shadow.radius = 16
    light.shadow.bias = -0.0001
    light.shadow.mapSize.width = SHADOW_MAP.width
    light.shadow.mapSize.height = SHADOW_MAP.height
    
    light.position.set(1, 4, 1)
    scene.add(light)
  }

  const room = await loadModel('assets/gltf/room_1.glb')
  scene.add(room)

  let force = 0.5

  const frame = (time) => {
    const { x, y, z } = camera.position

    if (force >= 0.001) {
      camera.position.set(x - force, y - force, z - force)
      force /= 1.05
    }

    controls.update()
  }

  let postProcessingOn = false

  const btn = document.querySelector('#postprocessing')
  btn.addEventListener('click', () => {
    postProcessingOn = !postProcessingOn
    core.stopAnimationLoop()
    core.setAnimationLoop({ frame, composer: postProcessingOn ? composer : null })
  })

  core.setAnimationLoop({ frame })
}

main()
</script>
